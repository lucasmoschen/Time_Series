---
title: "Venda de Carros na Noruega"
author: "Lucas Moschen e Matheus Paes"
date: "31/08/2020"
output: beamer_presentation
---

## Importando os Dados

Primeiro, baixamos os dados e separamos a marca a ser estudada.

\vspace{10pt}

```{r, include = FALSE, message=FALSE }
#Importando bibliotecas
library(dplyr)
library(zoo)
library(forecast)
library(ggplot2)

setwd("~/Documents/GitHub/Time_Series")
```

\tiny
```{r, warning=FALSE, message = FALSE, highlight=TRUE}

cars_df  = read.csv('norway_new_car_sales_by_make.csv')
make = 'Ford'

make_df = subset(cars_df, Make == make)
make_df$Date <- zoo::as.yearmon(paste(make_df$Year, make_df$Month), "%Y %m")
```

## Série Temporal de Vendas

Podemos ver o gráfico da série.

\tiny
```{r, echo = FALSE}
ggplot(data = make_df, mapping = aes(x = Date, y = Quantity)) + 
  geom_point() + 
  labs(title = 'Vendas de carros da marca Ford por mês', 
       x = 'Mês/Ano', 
       y = 'Vendas') + 
  theme(plot.title = element_text(hjust = 0.5))
```

## Decomposição STL (Loess)

Podemos fazer uma decomposição, considerando a janela de 12 meses para verificar tendência e sazonalidade. 

\tiny

```{r, include = FALSE}
decomposition = stl(zooreg(make_df$Quantity, start = c(2007,1), frequency = 12), s.window = 12)
```

```{r, echo = FALSE}
plot(decomposition)
```

## Decompose Aditivo (Moving Average)

Agora, vamos considerar a decomposição com moving average. Modelo aditivo:

\tiny

```{r, include = FALSE}
decomposition = decompose(zooreg(make_df$Quantity, start = c(2007,1), frequency = 12), 
                          type = 'additive'
                          )
```

```{r, echo = FALSE}
par(mfrow=c(4,1), mai = c(0.1, 0.6, 0.3, 0.1))
plot(decomposition$x, xlab = 'Ano', ylab = 'Dados')
plot(decomposition$trend, xlab = 'Ano', ylab = 'T')
plot(decomposition$seasonal, xlab = 'Ano', ylab = 'S')
plot(decomposition$random, xlab = 'Ano', ylab = 'e')
```

## Decompose Multiplicativo (Moving Average)

Modelo multiplicativo:

\tiny

```{r, include = FALSE}
decomposition = decompose(zooreg(make_df$Quantity, start = c(2007,1), frequency = 12), 
                          type = 'multiplicative'
                          )
```

```{r, echo = FALSE}
par(mfrow=c(4,1), mai = c(0.1, 0.6, 0.3, 0.1))
plot(decomposition$x, xlab = 'Ano', ylab = 'Dados')
plot(decomposition$trend, xlab = 'Ano', ylab = 'T')
plot(decomposition$seasonal, xlab = 'Ano', ylab = 'S')
plot(decomposition$random, xlab = 'Ano', ylab = 'e')
```

## Modelo de Regressão (Polinomial + Sazonal (12))

\tiny

```{r, message = FALSE, warning=FALSE}
D <- factor(cycle(make_df$Date))
t <- seq(1:length(make_df$Date))

make_df_model <- data.frame(Q = make_df$Quantity, t = t, D = D)

MAPE = function(z, degree){
  j <- nrow(z)-1
  model <- lm(formula = Q ~ poly(t, degree) + D, data = as.data.frame(z)[1:j,])
  y <- as.data.frame(z)[nrow(z),]
    yhat <- predict(model, y)
  ratio <- abs((y$Q - yhat)/y$Q)
  return(ratio)
}

width = 25

  mape_poly <- rep(0, 5)
for(degree in seq(1,5)){
  for(i in seq(1, nrow(make_df_model)-width+1)){
    j <- width + i - 1
    mape_poly[degree] <- mape_poly[degree] + MAPE(make_df_model[i:j,], degree)
  }
  mape_poly[degree] <- mape_poly[degree]/(nrow(make_df_model)-width+1)  
}
mape_poly <- data.frame(degree = seq(1,5), MAPE = mape_poly)
```

## Modelo de Regressão (Polinomial + Sazonal (12))

Podemos ver o resultado: 

```{r, echo = FALSE, messsage = FALSE}
ggplot(mape_poly) + 
  geom_bar( aes(x = degree, y = MAPE), stat = 'identity', fill="forestgreen", alpha=0.5) + 
  labs(x = 'Ordem polinomial', y = 'MAPE', 
      title = 'Comparando MAPE para diferentes polinômios') + 
  theme(plot.title = element_text(hjust = 0.5))
```

## Modelo de Decomposição Loess

## Modelo Exponencial Smoothing

\tiny

```{r}
exp.smooth <- HoltWinters(ts(make_df_model, frequency = 12, start = 2007), beta = F, gamma = F)
plot(exp.smooth$fitted, main= 'Exponencial Smoothing')
```

## Modelo Exponencial Smoothing: MAPE

\tiny

```{r}
es <- function(x){
  model <- HoltWinters(x, beta = F, gamma = F)
  coef(model)
}

make_df.ts <- ts(make_df_model$Q, frequency = 12, start = 2007)

r.exp <- rollapply(make_df.ts, FUN = es, 
               width = 24, align = 'right')

mape_exp <- mean(abs((make_df.ts - r.exp)/make_df.ts))
```

## Modelo Exponencial Smoothing: Previsão

\tiny

```{r}
plot(make_df$Date, make_df$Quantity, xlab = 'Anos', ylab = 'Quantidade de vendas', 
                                     main = 'Previsão do Primeiro Passo ES')
lines(r.exp)
```

## Modelo Holt Winters

\tiny

```{r}
holt <- HoltWinters(make_df.ts)
plot(holt$fitted, main = 'Holt Winters')
```

## Modelo Holt: MAPE 

\tiny

```{r}
h <- function(x){
  model <- HoltWinters(x, gamma = F)
  model$fitted
}

r.h <- rollapply(make_df.ts, FUN = h, width = 24, align = 'right')

mape_hw <- mean(abs((make_df.ts - r.h[,1])/make_df.ts))
```

## Modelo Holt: Previsão

\tiny

```{r}
plot(make_df$Date, make_df$Quantity, xlab = 'Anos', ylab = 'Quantidade de vendas', 
                                     main = 'Previsão do Primeiro Passo Holt')
lines(r.h[,1])
```

## Comparando modelos 
